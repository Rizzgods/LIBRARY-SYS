
{% load static %}



<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ book.BookTitle }} - Preview</title>
    <link rel="icon" href={% static "playground/school_Logo.png" %}>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <style>
        html{
            width:100%;
            height: 100%;
            overflow: auto;
        }
        .notification-time {
            font-size: 0.8rem;
            color: grey;
            margin-left: auto;
        }
        *{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, Helvetica, sans-serif;
        }
        
        body {
            position: relative;
        }
        .footer {
            grid-area: footer;
            display: flex;
            flex-direction: column;
            background-color: rgba(217,217,217, .5);
            padding: 10px 20px;
            align-self: flex-end;
            width:100%;
        }
        .second-footer{
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 50px;
        }
        .first-footer{
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
            font-weight:bold;
            padding-top: 20px;
        }
        .footer-details{
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            list-style: none;
            gap: 30px
        }
        
        .form-inline {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .form-control {
            margin: 5px;
        }
        
        .content {
            margin-top: 10%;
            position: relative;
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
        }
        .header{
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 25px;
            padding-left: 25px;
            background-color: rgb(74, 128, 210);
            top: 0;
            position: fixed;
            z-index: 1030;
            grid-area: header;
            width: 100%;
            height: 100px;
            animation: fadeInHeader 0.5s ease forwards;
            flex-wrap: nowrap;
        }
    
        /* Define animation keyframes for carousel */
        @keyframes fadeInCarousel {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        a{
            display:flex;
            justify-content: center;
            align-items: start;
            text-decoration: none;
            color: black;
            transition: color .2s
        }
        .logo-img{
            margin-left: 10px;
        }


        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 5px 10px;
            font-size: 12px;
            transform: translate(10px, -10px);
        }
        .dropdown {
            display: none;
            position: absolute;
            top: 45px;
            right: 0;
            background-color: white;
            color: black;
            width: 700px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: 5px;
            overflow: hidden;
            z-index: 1;
        }
        #notification-dropdown {
            max-height: 300px;  /* Set a maximum height for the dropdown */
            overflow-y: auto;   /* Allow vertical scrolling when content exceeds the height */
        }
        .dropdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
        }
    
        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background-color: #f1f1f1;
        }
        
        .dropdown-item.read {
            font-weight: normal;
        }
        .dropdown-item:not(.read) {
            font-weight: bold;
        }
        .dropdown-menu.show {
            transform: scaleY(0);
            opacity: 1;
            width: 218px;
            background-color: transparent;
            border: none;
            position: relative;
            padding: 0;
          }
          #li-dropdown{
            padding: 0;
            margin: 20;
          }
          .dropdown-btn{
            box-sizing: border-box;
            width: 100%;
            height: 100%;
            background-color: transparent;
            border: none;
            color: white;
            padding: 20px;
          }
          
        .notification-icon, .notification-icon-2 {
            width: 45px;
            height: 45px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .icon-2:hover{
            color: white;
        }
        .notification-icon {
            margin-right: 75px;
            border-radius: 50%;
            background-color: #e9ecef;
        }
        .notification-icon .badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: red;
            color: white;
            border-radius: 50%;
        }
        .material-symbols-outlined {
            font-size: 35px;
            cursor: pointer;
            transition: color 0.3s;
        }
    
        .material-symbols-outlined:hover {
            color: #808080;
        }
        .btn-close{
            width: 10px;
            height: 10px;
        }

        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
            overflow: auto;
        }
        #pdf-container {
            margin: 0px 10px;
            margin-top: 20px;
            width: 700px; /* Set fixed width */
            height: 80vh;
            overflow: hidden; /* Hide scrollbars but allow dragging */
            white-space: nowrap;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            cursor: grab;
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            position: relative; /* Ensure that the container remains relative for absolute movement */
        }

        #zoom-controls, #page-controls, #speaker-controls {
            margin-top: 10px;
        }
        #zoom-controls{
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            align-self: flex-start;
        }
        .button-design{
            background-color: #007bff;
            color: white;
            border: none;
            padding: 7.5px;
            margin: 5px;
            cursor: pointer;
            border-radius: 5px;
            max-height:50px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #page-input {
            margin-left: 10px;
            padding: 5px;
            width: 50px;
            text-align: center;
        }
        .pdf-controls{
            position: absolute;
            top: 100px;
            left: 75%;
        }
        .pdf-controls-2{
            position: absolute;
            top: 850px;
            left: 480px;
        }
        .static-div{
            postion:relative;
        }
        .page-count{
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .back-icon{
            width: 35px;
            color: white;
            transform: translateY(15px);
        }
        .back-icon:hover{
            color: rgba(255, 255, 255, .7)
        }
        .nav-arrow{
            border: none;
            background-color: transparent;
        }
        .nav-arrow:hover{
            background-color: transparent;
        }
        .icons{
            font-weight: light;
        }
        .icons:hover{
            color: white;
        }
        .icon-2:hover{
            color: black;
        }
        .notif-link{
            display: flex;
            flex-direction: row;
            justify-content: start;
            border-right: 1px solid rgba(0, 0, 0, 0.3);
            flex-grow: 1;
            margin-right: 10px;
          }
        .text-to-speech{
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
        }
        .page-views-count{
            background-color: rgba(255, 255, 255, 0.3);
            border: 1px solid transparent;
            border-radius: 10px;
            padding: 10px 20px;
            color: white;
            font-size: 1.1rem;
            margin-top: 10px;
        }
        .pdf-viewer{
            display: flex;
            flex-direction: row;
            margin-top: 10px;
        }
        .notif-btn{
            color: rgb(73, 110, 232);
            text-decoration: none !important; 
            font-weight: bold;
            font-size: 0.875rem;
            padding: 0.25rem;
          }
          .notif-btn:hover{
            color: rgba(73, 110, 232, .5);
          }
          #notification-dropdown {
            max-height: 300px;  /* Set a maximum height for the dropdown */
            overflow-y: auto;   /* Allow vertical scrolling when content exceeds the height */
        }
        .logo{
            display: flex;
            flex-direction: row;
            justify-content: center;
        }
        .fb-logo{
            width: 40px;
        }
        .loc-logo{
            width: 35px;
        }
        .speaker-btns{
            display:flex;
            justify-content: center;
        }
        .page-number{
            padding: 0px;
            display:flex;
            justify-content: center;
        }
        .pdf-holder {
            display: grid;
            grid-template-columns: 100px 1fr 100px;
            grid-template-rows: 1fr 100px;
            grid-template-areas:
            "arrow-back pdf-viewer arrow-forward"
            "speaker-btns page-number zoom-controls";
        }
        .arrow-forward{
            grid-area: arrow-forward;
            display: flex;
            justify-content: flex-start;
            align-items: center;
        }
        .arrow-back{
            grid-area: arrow-back;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }
        .pdf-viewer{
            grid-area: pdf-viewer;
        
        }
        .page-number{
            grid-area: page-number;
            display: flex;
            justify-content: center;
            align-items: center;
            max-height: 50px;
            margin-top: 10px;
        }
        #zoom-controls{
            grid-area: zoom-controls;
            padding-right: 200px;
        }
        .speaker-btns{
            grid-area: speaker-btns;
            padding-left: 140px;
            margin-top: 10px;
        }


        @media (max-width: 1250px) {
            .first-footer-text{
                font-weight: 400;
                font-size: .8rem;
            }      
        }
          @media (max-width: 768px) {
            #logo{
                height: 55px;
            }
            .page-views-count{
                font-size: 15px;
            }
            .notification-icon {
                margin-right: 20px;
            }
            .second-footer .fb-logo, .second-footer .loc-logo {
                width: 30px;
            }
            .second-footer .footer-text {
                font-size: 0.8rem;
                text-align: center;
            }
            .footer-details {
                display: grid;
                grid-template-columns: 1fr 1fr; /* Adjust the number of columns as needed */
                gap: 10px;
            }
            .dropdown-item-list{
                padding-left: 10px;
            }
            .dropdown{
                width: 500px;
            }
            .dropdown-item{
                text-wrap: wrap;
            }
        }
          @media (max-width: 530px) {
            #logo{
                height: 50px;
            }
            .fb-logo{
                width: 35px;
            }
            .loc-logo{
                width: 30px;
            }
            .notification-icon {
                margin-right: 20px;
            }
            .dropdown-item-list{
                padding-left: 10px;
            }
            .dropdown{
                width: 400px;
            }
            .dropdown-item{
                text-wrap: wrap;
            }
        }
        @media (max-width: 435px) {
            #logo{
                height: 45px;
            }
            .logo-img{
                margin: 0px;
            }
            .header{
                padding: 5px;
                width: 100%;
            }
            .dropdown-item-list{
                padding-left: 10px;
            }
            .dropdown{
                width:325px;
            }
            .dropdown-item{
                text-wrap: wrap;
            }
            .notif-link{
                font-size: 15px;
            }
            .page-views-count{
                padding: 5px 10px;
            }
            #pdf-container{
                width: 370px;
            }
            .content{
                margin-top: 70%;
                margin-bottom: 20px;
            }
            .pdf-holder {
                grid-template-rows: auto 1fr auto;
                grid-template-areas:
                "arrow-back page-number arrow-forward"
                "pdf-viewer pdf-viewer pdf-viewer"
                "speaker-btns none zoom-controls";
                column-gap: 0px;
            }
            .arrow-back {
                display: flex;
                justify-content: end;
            }
            
            .page-number {
                display: flex;
                justify-content: center;
                align-items: center;
            }
            
            .arrow-forward {
                display: flex;
                justify-content: start;
            }
            
            .pdf-viewer {
                overflow: auto;
                margin: 0px;
            }
            
            .speaker-btns {
                align-items: center;
            }
            
            #zoom-controls {
                align-items: center;
                margin-right: 200px;
            }
            .back-icon{
                font-size: 25px;
            }
        }
        @media(max-width: 380px){
            .content{
                margin-top: 75%;
            }
        }


    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="logo">
            <a href="#" id="back-button" onclick="history.go(-1); return false;"><span class="material-symbols-outlined back-icon">arrow_back</span></a>
            <a href="{% url 'view' %}"class="logo-img">
                <img src="{% static 'playground/Logo.png' %}" alt="Logo" height="80px" id="logo">
            </a>
        </div>
        <p class="page-views-count">Page Views: {{ book.PageViews }}</p>
        <div class="notification-icon">
            <span class="material-symbols-outlined" id="notification-bell">notifications</span>
            <span class="notification-badge" id="notification-count">0</span>
            <div class="dropdown" id="notification-dropdown">
                <div class="dropdown-header d-flex justify-content-between align-items-center">
                    <button id="mark-all-read" class="btn btn-link notif-btn">Mark All as Read</button>
                    <button id="see-more-less-btn" class="btn btn-link notif-btn" style="display: none;">See More</button>
                </div>
                <!-- Notification list -->
                <ul id="notification-list" class="dropdown-item-list"></ul>
        
                <!-- No notifications message -->
                <span class="dropdown-item-text no-notif" id="no-notifications" style="display: none;">No notifications</span>
            </div>
        </div>
    </header>
    <div class="content">
        <div class="pdf-holder">
            <div class="static-div arrow-back">
                <button onclick="prevPage()" class="nav-arrow nav-arrow-back">
                    <span class="material-symbols-outlined">arrow_back_ios</span>
                </button>
            </div>
            <div class="static-div page-number">
                <span id="page-counter" aria-live="polite"></span>
                <input type="text" id="page-input" placeholder="Page" onkeydown="jumpToPage(event)">
            </div>
            <div class="static-div arrow-forward">
                <button onclick="nextPage()" class="nav-arrow">
                    <span class="material-symbols-outlined">arrow_forward_ios</span>
                </button>
            </div>
            <div class="pdf-viewer">
                <div id="pdf-container" onmousedown="startDragging(event)" onmousemove="drag(event)" onmouseup="stopDragging(event)" oncontextmenu="return false;"></div>
            </div>
            <div class="speaker-btns">
                <button onclick="readPage()" class="button-design">
                    <span class="material-symbols-outlined">text_to_speech</span>
                </button>
                <button onclick="togglePauseResume()" class="button-design">
                    <span class="material-symbols-outlined" id="pauseResumeButton">pause</span>
                </button>
                <button onclick="stopReading()" class="button-design">
                    <span class="material-symbols-outlined" id="pauseResumeButton">stop</span>
                </button>
            </div>
            <div id="zoom-controls">
                <button onclick="zoomIn()" class="button-design">
                    <span class="material-symbols-outlined">zoom_in</span>
                </button>
                <button onclick="zoomOut()" class="button-design">
                    <span class="material-symbols-outlined">zoom_out</span>
                </button>
            </div>
        </div>
    </div>
    <div class="footer">
        <div class="first-footer hidden">
            <span>Contact Us: </span>
            <ul class="footer-details">
                <li>
                    <img src="{% static 'playground/email-icon.png' %}" width="35px"/>
                    <span class="first-footer-text">lawangbato.nhs@deped.gov.ph</span>
                </li>
                <li>
                    <img src="{% static 'playground/call-icon.png' %}" width="20px"/>
                    <span class="first-footer-text">Admin: (02)8983-9321</span>
                </li>
                <li>
                    <img src="{% static 'playground/email-icon.png' %}" width="35px"/>                        
                    <span class="first-footer-text">lawangbato_nationalhighschool@yahoo.com</span>
                </li>
                <li>
                    <img src="{% static 'playground/call-icon.png' %}" width="20px"/>                        
                    <span class="first-footer-text">Registrar: 09932737625</span>
                </li>
            </ul>
        </div>  
        <div class="second-footer hidden">
            <div class="d-flex flex-direction-row justify-content-center align-items-center">
                <a href="https://www.facebook.com/305440LBNHS" class="mx-4">
                    <img class="fb-logo" src="{% static 'playground/fb-logo.png' %}"/>
                </a>
                <a href="https://www.google.com/maps/place/Lawang+Bato+National+High+School/@14.7296792,120.9912317,17z/data=!3m1!4b1!4m6!3m5!1s0x3397b17f71f6fd1b:0x3442c8fb7481b19a!8m2!3d14.7296792!4d120.9938066!16s%2Fm%2F06zknph?entry=ttu&g_ep=EgoyMDI0MDkxOC4xIKXMDSoASAFQAw%3D%3D" target="_blank">
                    <img class="loc-logo" src="{% static 'playground/map-logo.png' %}" width="35px"/>
                </a>
            </div>
            <span class="footer-text">Â© 2024 LBLIB | Lawang Bato National Highschool</span>
            <div></div>
        </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js" integrity="sha512-bPs7Ae6pVvhOSiIcyUClR7/q2OAsRiovw4vAkX+zJbw3ShAeeqezq50RIIcIURq7Oa20rW2n2q+fyXBNcU9lrw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>

    let pdfDoc = null;
    let pageNum = 1;
    let scale = 1.0;
    let isDragging = false;
    let startX, startY, scrollLeft, scrollTop;
    let utterance = null;
    let recognition = null;
    let currentX = 0, currentY = 0;
    let xOffset = 0, yOffset = 0;

    const zoomStep = 0.1; // Step size for each scroll event
    const minScale = 0.25; // Minimum zoom scale
    const maxScale = 4.0; // Maximum zoom scale

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    const pdfContainer = document.getElementById("pdf-container");
    const pageCounter = document.getElementById("page-counter");
    const pageInput = document.getElementById("page-input");
    

    // Function to handle zooming in and out based on scroll direction
    function handleScrollZoom(e) {
        e.preventDefault(); // Prevent default scroll behavior

        // Check scroll direction and adjust scale
        if (e.deltaY < 0) {
            // Scrolled up -> zoom in
            if (scale < maxScale) {
                scale += zoomStep;
            }
        } else {
            // Scrolled down -> zoom out
            if (scale > minScale) {
                scale -= zoomStep;
            }
        }

        // Re-render the page with the updated scale
        renderPage(pageNum, scale);
    }

        // Function to speak command success message
        function speakCommandSuccess(message) {
            utterance = new SpeechSynthesisUtterance(message);
            speechSynthesis.speak(utterance);
        }   
    
        function nextPage() {
            stopReading(); // Stop TTS before navigating
            if (pageNum < pdfDoc.numPages) {
                pageNum++;
                renderPage(pageNum, scale, false); // Set shouldRead to false
                
            }
        }
    
        function prevPage() {
            stopReading(); // Stop TTS before navigating
            if (pageNum > 1) {
                pageNum--;
                renderPage(pageNum, scale, false); // Set shouldRead to false
                
            }
        }
    
        function renderPage(pageNum, scale, shouldRead = false) {
            pdfDoc.getPage(pageNum).then(function(page) {
                const viewport = page.getViewport({ scale: scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
        
                // Center the canvas
                canvas.style.display = 'block';
                canvas.style.margin = '0 auto';
                canvas.style.padding = '50px';
        
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                page.render(renderContext).promise.then(() => {
                    // Add watermark
                    ctx.save();
                    ctx.setTransform(1, 0, 0, 1, 0, 0); // Reset any transformations
                    ctx.font = `${30}px Arial`; // Base font size
                    ctx.fillStyle = "rgba(255, 0, 0, 0.3)";
                    ctx.textAlign = "center";
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate(-Math.PI / 4);
                    ctx.scale(scale, scale); // Scale the watermark based on the zoom level
                    ctx.fillText("PROPERTY OF LAWANG BATO NATIONAL HIGH SCHOOL", 0, 0);
                    ctx.restore();
        
                    if (!pdfContainer.contains(canvas)) {
                        pdfContainer.appendChild(canvas);
                    }
                });
                page.getTextContent().then(function(textContent) {
                    const textItems = textContent.items;
                    let finalText = '';
                    for (let i = 0; i < textItems.length; i++) {
                        finalText += textItems[i].str + ' ';
                    }
                    canvas.setAttribute('data-text', finalText);
                    if (shouldRead) {
                        readPage();
                    }
                });
            }).catch(error => {
                console.error('Error rendering page:', error);
            });
            pageCounter.textContent = `${pageNum} / ${pdfDoc.numPages}`;
            pageInput.value = pageNum;
        }
        
        
    
        function readPage() {
            const text = canvas.getAttribute('data-text');
            if (text) {
                if (utterance) {
                    speechSynthesis.cancel(); // Cancel any ongoing speech
                }
                utterance = new SpeechSynthesisUtterance(text);
                speechSynthesis.speak(utterance);
                $('#notification').fadeIn(); // Show the notification
                setTimeout(function() {
                    $('#notification').fadeOut(); // Hide the notification after a delay
                }, 3000); // 3000 milliseconds = 3 seconds
            } else {
                console.error('No text found to read.');
            }
        }
    
        function stopReading() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
        }
    
        function zoomOut() {
            if (scale > 0.25) {
                scale -= 0.25;
                renderPage(pageNum, scale);
            }
        }
    
        function zoomIn() {
            if (scale < 4.0) {
                scale += 0.25;
                renderPage(pageNum, scale);
            }
        }
    
        // Ensure dragging is only done on the canvas inside the pdfContainer
        function startDragging(e) {
            if (e.target.tagName !== "CANVAS") return;  // Only allow dragging when the target is the canvas

            isDragging = true;
            pdfContainer.style.cursor = 'grabbing';

            // Get the starting positions of the mouse relative to the current offset
            startX = e.pageX - xOffset;
            startY = e.pageY - yOffset;

            e.preventDefault();  // Prevent text selection or default behavior
            e.stopPropagation(); // Prevent event propagation to other elements
        }

        function stopDragging(e) {
            if (!isDragging) return;  // Only stop if dragging is in progress

            isDragging = false;
            pdfContainer.style.cursor = 'grab';

            // Update offsets based on the current position
            xOffset = currentX;
            yOffset = currentY;

            e.preventDefault();
            e.stopPropagation();
        }

        function drag(e) {
            if (!isDragging) return;  // Do nothing if we're not dragging

            // Calculate the new position based on the mouse movement
            currentX = e.pageX - startX;
            currentY = e.pageY - startY;

            // Move the canvas by translating its position
            canvas.style.transform = `translate(${currentX}px, ${currentY}px)`;  // Apply dragging only to the canvas

            e.preventDefault();  // Prevent text selection or default behavior
            e.stopPropagation(); // Prevent event propagation
        }

        // Attach event listeners to the pdfContainer for the canvas
        pdfContainer.addEventListener('mousedown', startDragging);
        pdfContainer.addEventListener('mousemove', drag);
        pdfContainer.addEventListener('mouseup', stopDragging);
        pdfContainer.addEventListener('mouseleave', stopDragging);

    
        function jumpToPage(e) {
            if (e.key === 'Enter') {
                const page = parseInt(pageInput.value);
                if (page > 0 && page <= pdfDoc.numPages) {
                    pageNum = page;
                    renderPage(pageNum, scale);
                }
            }
        }
    
        function togglePauseResume() {
            const button = document.getElementById('pauseResumeButton');
            if (speechSynthesis.speaking) {
                if (speechSynthesis.paused) {
                    speechSynthesis.resume(); // If paused, resume
                    button.textContent = "pause";
                } else {
                    speechSynthesis.pause(); // If speaking, pause
                    button.textContent = "resume";
                }
            }
        }

        function goToPage(pageNumber) {
            stopReading(); // Stop TTS before navigating
            if (pageNumber >= 1 && pageNumber <= pdfDoc.numPages) {
                pageNum = pageNumber;
                renderPage(pageNum, scale, false); // Set shouldRead to false
            } else {
                console.error('Invalid page number:', pageNumber);
            }
        }

        // Add CSS transition
        document.addEventListener('DOMContentLoaded', function() {
            const button = document.getElementById('pauseResumeButton');
            button.style.transition = "all 0.3s ease";
        });
    
        window.addEventListener('beforeunload', function(event) {
            stopReading();
        });
    
        pdfjsLib.getDocument("{{ book.BookFile.url }}").promise.then(function(pdf) {
            pdfDoc = pdf;
            renderPage(pageNum, scale);
        }).catch(error => {
            console.error('Error loading PDF:', error);
        });
    
        // Speech recognition setup
        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US'; // Set language to English
            recognition.continuous = false; // Stop listening after one phrase is recognized
    
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript.trim().toLowerCase();
                console.log('Recognized:', transcript);
                if (transcript === 'next.') {
                    nextPage();
                    speakCommandSuccess('Next page navigated.');
                } else if (transcript === 'stop.') {
                    stopReading();
                    speakCommandSuccess('Reading stopped.');
                } else if (transcript === 'read.') {
                    readPage();
                    speakCommandSuccess('Reading started.');
                } else if (transcript === 'previous.') {
                    prevPage();
                    speakCommandSuccess('Previous page navigated.');
                } else if (transcript.startsWith('go to page')) {
                    const words = transcript.split(' ');
                    const pageNumberIndex = words.indexOf('page') + 1; // Find the index of the word "page"
                    if (pageNumberIndex !== 0 && pageNumberIndex < words.length) {
                        const pageNumber = parseInt(words[pageNumberIndex]);
                        if (!isNaN(pageNumber)) {
                            goToPage(pageNumber);
                            speakCommandSuccess(`Navigated to page ${pageNumber}.`);
                        } else {
                            console.error('Invalid page number:', words[pageNumberIndex]);
                        }
                    } else {
                        console.error('Page number not found in transcript:', transcript);
                    }
                }
                else if (transcript === 'pause.' || 'wait.') {
                    speakCommandSuccess('Reading pause');
                    togglePauseResume();
                    
                } else if (transcript === 'resume.' || 'go on.') {
                    speakCommandSuccess('Reading continue');
                    togglePauseResume();
                    
                }
                else if (transcript === 'zoom in.' || 'in.') {
                    zoomIn();
                    speakCommandSuccess('Zooming In');
                }
                else if (transcript === 'zoom out.') {
                    zoomOut();
                    speakCommandSuccess('Zooming out');
                }
            };
    
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
            };
    
            recognition.onend = function() {
                // Restart recognition after it ends
                recognition.start();
            };
    
            // Start recognition
            recognition.start();
        } else {
            console.error('Speech recognition not supported in this browser.');
        }

        {% comment %} notif js {% endcomment %}
        $(document).ready(function() {
            var showingMore = false;  // Track the state of "See More"/"See Less"
            var notifications = [];   // Store notification data locally
            var notificationsToShow = 5;  // Default number of notifications to show
            var pollingInterval = 10000;  // Poll every 10 seconds
        
            function fetchNotifications() {
                $.get("{% url 'fetch_notifications' %}", function(data) {
                    notifications = data;
                    renderNotifications();
                });
            }
            
            // Call fetchNotifications every 10 seconds
            setInterval(fetchNotifications, pollingInterval);
            fetchNotifications();  // Fetch immediately on page load
            
            function renderNotifications() {
                $('#notification-list').empty();
        
                if (notifications.length > 0) {
                    var unreadCount = notifications.filter(function(notification) {
                        return !notification.read;
                    }).length;
                    
                    $('#notification-count').text(unreadCount).show();
                    $('#no-notifications').hide();
        
                    var notificationsToDisplay = showingMore ? notifications.length : notificationsToShow;
                    var limitedNotifications = notifications.slice(0, notificationsToDisplay);
        
                    limitedNotifications.forEach(function(notification) {
                        var item = $('<div class="dropdown-item">')
                            .html(`
                                <a href="javascript:void(0)" class="notif-link">
                                    <div class="notification-icon-2">
                                        <span class="material-symbols-outlined icon-2">notification_important</span>
                                    </div>
                                    <div class="notif-message">
                                        ${notification.message}
                                        <div class="notification-time">${new Date(notification.created_at).toLocaleString()}</div>
                                    </div>
                                </a>
                            `)
                            .attr('data-id', notification.id)
                            .toggleClass('read', notification.read)
                            .click(function() {
                                markAsReadAndRedirect(notification.id, notification.type);
                            });
        
                        var deleteButton = $('<button class="btn btn-close ms-auto">').html('').click(function(event) {
                            event.stopPropagation();
                            deleteNotification(notification.id);
                        });
        
                        item.append(deleteButton);
                        $('#notification-list').append(item);
                    });
        
                    // Show or hide the See More/See Less button based on the number of notifications
                    if (notifications.length > notificationsToShow) {
                        $('#see-more-less-btn').show().text(showingMore ? 'See Less' : 'See More');
                    } else {
                        $('#see-more-less-btn').hide();
                    }
                } else {
                    $('#notification-list').html('<span class="dropdown-item-text no-notif">No notifications</span>');
                    $('#notification-count').hide();
                    $('#see-more-less-btn').hide();
                }
            }
        
            // Toggle "See More" and "See Less"
            $('#see-more-less-btn').on('click', function(event) {
                event.stopPropagation();
                showingMore = !showingMore;
                renderNotifications();
            });
        
            function markAsReadAndRedirect(notificationId, notificationType) {
                $.post("{% url 'mark_notification_read' 0 %}".replace('0', notificationId), {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                }, function() {
                    let requestType = 'pending';  // Default to pending
                    if (notificationType === 'approved') {
                        requestType = 'approved';
                    } else if (notificationType === 'declined') {
                        requestType = 'declined';
                    }
    
                    // Update local state
                    notifications = notifications.map(function(notification) {
                        if (notification.id === notificationId) {
                            notification.read = true;
                        }
                        return notification;
                    });
    
                    // Update the badge count
                    var unreadCount = notifications.filter(function(notification) {
                        return !notification.read;
                    }).length;
    
                    if (unreadCount > 0) {
                        $('#notification-count').text(unreadCount).show();
                    } else {
                        $('#notification-count').hide();
                    }
    
                    renderNotifications();
                    window.location.href = "{% url 'borrowed_books' %}?requestType=" + requestType;
                });
            }
        
            function markAllAsRead() {
                $.post("{% url 'mark_all_notifications_read' %}", {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                }, function() {
                    notifications.forEach(function(notification) {
                        notification.read = true;  // Update local state
                    });
    
                    // Hide the badge
                    $('#notification-count').hide();
    
                    renderNotifications();
                });
            }
        
            function deleteNotification(notificationId) {
                $.post("{% url 'delete_notification' 0 %}".replace('0', notificationId), {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                }, function() {
                    notifications = notifications.filter(function(notif) {
                        return notif.id !== notificationId;
                    });
                    renderNotifications();
                });
            }
        
            $('#notification-bell').on('click', function() {
                $('#notification-dropdown').toggle();
                if ($('#notification-dropdown').is(':visible')) {
                    fetchNotifications();
                }
            });
        
            setInterval(fetchNotifications, 60000);  // Fetch notifications every 60 seconds
            fetchNotifications();
        
            $(document).click(function(event) {
                if (!$(event.target).closest('#notification-bell').length && !$(event.target).closest('#notification-dropdown').length) {
                    $('#notification-dropdown').hide();  // Hide dropdown when clicking outside
                }
            });
    
            $('#mark-all-read').on('click', function() {
                markAllAsRead();
            });
        });
    
    </script>
</body>
</html>


           